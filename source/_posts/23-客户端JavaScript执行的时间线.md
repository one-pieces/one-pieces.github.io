---
title: 23.浏览器JavaScript执行的时间线
date: 2018-11-09 15:29:40
tags: [JavaScript, 浏览器]
---

## 前言
我们知道浏览器的渲染线程和脚本线程是互斥的，JavaScript会阻塞浏览器HTML解析器，这也是为什么长时间的脚本运行可能会导致页面失去响应。因此，我们通常会把`<script>`放在`</body>`之前，来保证非脚本的其他一切元素能尽快地得到加载和解析。  
然而，我们可以通过设置`<scirpt>`的`async`和`defer`来改变`<script>`的加载和执行顺序。在说这具体是怎样之前,我们先介绍一下浏览器JavaScript执行的时间线。

## JavaScript的执行
1. 浏览器创建`Document`对象，并且开始解析Web页面，解析HTML元素和它们的文本内容后，会添加Element对象和Text节点到文档中。在这个阶段document.readystate属性的值是`loading`。

2. 当HTML解析器遇到没有`async`和`defer`属性的`<script>`元素时，它把这些元素添加到文档中，然后执行行内或者外部脚步。这些脚本会同步执行，并且在脚本下载（如果需要）和执行时，HTML解析器会暂停。这样脚本就可以用`document.write()`来把文本插入到输入流中。解析器恢复时这些文本会成为文档的一部分。同步脚本经常简单定义函数和注册后面使用的注册事件处理程序，但它们可以遍历和操作文档树，因为在它们执行时已经存在了。这样，同步脚本可以看到它自己的`<script>`元素和它们之前的文档内容。

3. 当解析器遇到设置了`async`属性的`<script>`元素时，它开始下载脚本文本，并继续解析文档。脚本会在它下载完成后尽快执行，但是解析器没有停下来等它下载。异步脚本禁止使用`document.write()`方法。它们可以看到自己的`<script>`元素和它之前的所有文档元素，并且可能或干脆不访问其他的文档内容。

4. 当文档完成解析，`document.readyState`属性变成`interactive`。

5. 所有有`defer`属性的脚本，会按它们在文档里的出现顺序执行。异步脚本可能也会在这个时间执行。延迟脚本能访问完整的文档树，禁止使用`document.write()`方法。

6. 浏览器在`Document`对象上触发`DOMContentLoaded`事件。这标志着程序执行从同步脚本执行阶段转换到了异步事件驱动阶段。但要注意，这时可能还有异步脚本没有执行完成。

7. 这时，文档已经完全解析完成，但是浏览器可能还在等待其他内容载入，比如图片。当所有这些内容完成载入时，并且所有异步脚本完成载入和执行，`document.readyState`属性改变为`complete`，浏览器触发`Window`对象上的`load`事件。

8. 从此刻起，会调用异步事件，以异步响应用户输入事件、网络事件、计时器过期等。

需要注意的是，这是一条理想的时间线，每种浏览器的具体细节实现可能不一样。

## 总结

经过上面的分析，我们可以总结一下。当浏览器遇到`<script>`脚本时：

1. 同步脚本`<script src="script.js"></script>`
    没有`defer`或`async`，浏览器会立即加载并执行指定的脚本，`立即`指的是在渲染该`<script>`标签之下的文档元素之前，也就是说文档解析器会暂停，浏览器读到就加载并执行。

2. 异步脚本`<script async src="script.js"></script>`
    有`async`，加载和渲染后续文档元素的过程和`script.js`的加载与执行并行进行（异步）。

3. 延迟脚本`<script defer src="script.js"></script>`
    有`defer`，加载后续文档元素的过程和`script.js`的加载并行进行（异步），但是`script.js`的执行要在所有元素解析完成（`document.readyState`属性变成`interactive`）之后，`DOMContentLoaded`事件触发之前完成。

最后用一张图来总结：
![image](../images/23/1.png)