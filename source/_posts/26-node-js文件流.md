---
title: 26.node.js文件流
date: 2018-12-05 14:06:03
tags: [node.js, 文件流]
---
### 1.流的基本概念
在一个应用程序中，流是一组有序的、有起点和终点的字节数据的传输手段。在应用程序中各种对象之间交换与传输数据时，总是先将该对象中所包含的数据转换为各种形式的流数据（即字节数据），再通过流的传输，到达目标对象后再将数据转换为该对象中可以使用的数据。

在 Node.js 中，我们可以使用实现了 `stream.Readable` 或 `stream.Writeable` 接口的对象来将对象数据读取为流数据，或者将流数据写入到对象中。它们都继承了 `EventEmitter` 类的实例对象，在读取数据或写入数据的过程中，将可能触发各种事件。

##### <center>表1-1 Node.js中的各种用于读取数据的对象</center>
| 对象 | 描述|
| ---- | ---- |
| fs.ReadStream | 用于读取文件 |
| http.IncomingMessage | 代表客户端请求或服务器端响应 |
| net.Socket | 代表一个 socket 端口对象 |
| child.stdout | 用于创建子进程的标准输出流。如果子进程与父进程共享输入输出流，则子进程的标准输出流被废弃 |
| child.stderr | 用于创建子进程的标准错误输出流。如果子进程与父进程共享输入输出流，则子进程的标准错误输出流被废弃 |
| process.stdin | 用于创建进程的标准输入流 |
| Gzip</br> Deflate</br> DeflateRaw | 用于实现数据压缩 |

##### <center>表1-2 读取数据的对象将会触发的事件</center>
| 事件名 | 描述|
| ---- | ---- |
| readable | 当可以从流中读出数据时触发。在大多数情况下，如果指定了 `readable` 事件的回调函数，将迫使操作系统将流数据首先读入操作系统缓存区中，然后再从操作系统缓存区中读出数据，当操作系统缓存区中对象被全部读出，且可以继续从流中读取数据时，将触发一个新的 `readable` 事件 |
| data | 当读取到来自于文件、客户端、服务器端等对象的新的数据时触发 `data` 事件。如果指定 `data` 事件的回调函数，将使用 `flowing` 模式来读取流数据（在 Node.js 中，可以使用 `flowing` 模式与 非 `flowing` 模式来读取数据。当使用 `flowing` 模式时，将使用操作系统的内部 I/O 机制来读取数据，，这允许你以最快速度读取数据。当使用非 `flowing` 模式时，你必须显式调用对象的 `read` 方法来读取数据）。参数值为存放了已读取到的数据的缓存区对象或一个字符串（当对流数据指定编码格式时） |
| end | 当读取完所有数据时触发，该事件的触发意味着 `data` 事件将不再被触发 |
| error | 当读取数据过程中产生错误时触发 |
| close | 当用于读取流数据的对象被关闭时触发。并非所有用于读取流数据的对象都会触发该事件 |

##### <center>表1-3 读取数据的对象的方法</center>
| 事件名 | 描述|
| ---- | ---- |
| read | 用于读取数据 |
| setEncoding | 用于指定用什么编码方式读取数据 |
| pause | 用于通知对象停止触发 `data` 事件 |
| resume | 用于通知对象恢复触发 `data` 事件 |
| pipe | 用于设置一个数据通道，然后取出所有流数据并将其输出到通道另一端所指向的目标对象中 |
| unpipe | 用于取消在 `pipe` 方法中设置的通道 |
| unshift | 当对流数据绑定了一个解析器时，可以使用 `unshift` 方法来取消该解析器的绑定，使流数据可以通过其他方式解析 |

##### <center>表1-4 Node.js中的各种用于写入数据的对象</center>
| 对象 | 描述|
| ---- | ---- |
| fs.WriteStream | 用于写入文件 |
| http.ClientRequest | 用于写入 HTTP 客户端请求数据 |
| http.ServerResponse | 用于写入 HTTP 服务端响应数据 |
| net.Socket | 用于读写 TCP 流或 UNIX 流，可被用户创建并作为一个客户端来使用，也可被 Node.js 脚本程序创建并通过服务器的 connection 事件来传递给用户 |
| child.stdin | 用于创建子进程的标准输入流。使用该对象的 close 方法将终止子进程。如果子进程与父进程共享输入输出流，则子进程的标准输入流数据被废弃 |
| process.stdout | 用于创建进程的标准输出流 |
| process.stderr | 用于创建进程的标准错误输出流 |
| Gunzip</br> Inflate</br> InflateRaw | 用于解压数据 |

##### <center>表1-5 写入数据的对象将会触发的事件</center>
| 事件名 | 描述|
| ---- | ---- |
| drain | 当用于写入数据的 write 方法返回 false 之后触发，表示操作系统缓存区中的数据已全部输出到目标对象中，可以继续向操作系统缓存区写入数据 |
| finish | 当 end 方法被调用且数据被全部写入操作系统缓存区时触发 |
| pipe | 当用于读取数据的对象的 pipe 方法被调用时触发 |
| unpipe | 当用于读取数据的对象的 unpipe 方法被调用时触发 |
| error | 当写入数据的过程中产生错误时触发 |

##### <center>表1-6 写入数据的对象的方法</center>
| 事件名 | 描述|
| ---- | ---- |
| write | 用于写入数据 |
| end | 当没有数据再被写入流中时调用该方法，这将迫使操作系统缓存区中的剩余数据被立即写入目标对象中。当该方法被调用后，将不能继续在目标对象中写入数据 |

